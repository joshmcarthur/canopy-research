{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Canopy Research{% endblock %}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/themes/light.css" />
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/shoelace-autoloader.js"></script>
    <script src="https://unpkg.com/htmx.org@2.0.8/dist/htmx.min.js"></script>
    <link rel="stylesheet" href="{% static 'canopyresearch/theme.css' %}" />
</head>
<body class="app-shell">
    {% if user.is_authenticated %}
    <header class="app-header">
        <div class="app-header-start">
            <a href="/" class="brandmark">Canopy Research</a>
        </div>
        <div class="app-header-center">
            <sl-dropdown id="workspace-switcher" hoist>
                <button slot="trigger" class="workspace-switcher-trigger">
                    {% if active_workspace %}{{ active_workspace.name }}{% else %}Select workspace{% endif %}
                    <sl-icon name="chevron-down"></sl-icon>
                </button>
                <sl-menu>
                    {% for ws in workspaces %}
                    <sl-menu-item value="{{ ws.id }}" {% if ws == active_workspace %}checked{% endif %}>
                        {{ ws.name }}
                    </sl-menu-item>
                    {% endfor %}
                    {% if workspaces %}
                    <sl-divider></sl-divider>
                    {% endif %}
                    <sl-menu-item value="new">
                        <sl-icon slot="prefix" name="plus-lg"></sl-icon> New workspace
                    </sl-menu-item>
                </sl-menu>
            </sl-dropdown>
        </div>
        <div class="app-header-end"></div>
    </header>
    {% endif %}

    <sl-dialog id="resource-dialog" label="" style="--width: 480px;">
        <div id="dialog-body"></div>
    </sl-dialog>

    <div class="alert-container">
        {% for message in messages %}
        <sl-alert variant="{% if message.tags == 'error' %}danger{% elif message.tags == 'warning' %}warning{% elif message.tags == 'success' %}success{% else %}primary{% endif %}" open closable duration="4000">
            <sl-icon slot="icon" name="{% if message.tags == 'error' %}exclamation-triangle{% elif message.tags == 'success' %}check-circle{% elif message.tags == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %}"></sl-icon>
            {{ message }}
        </sl-alert>
        {% endfor %}
    </div>

    <main class="app-main">
        <div class="app-container">
            {% block content %}{% endblock %}
        </div>
    </main>

    {% if user.is_authenticated %}
    <script>
        (function() {
            var switcher = document.getElementById('workspace-switcher');
            if (switcher) {
                var menu = switcher.querySelector('sl-menu');
                if (menu) {
                    menu.addEventListener('sl-select', function(evt) {
                        var value = evt.detail.item.value;
                        if (value === 'new') {
                            window.location.href = '/';
                        } else if (value) {
                            window.location.href = '/workspaces/' + value + '/';
                        }
                    });
                }
            }
            document.body.addEventListener('closeDialog', function() {
                var d = document.getElementById('resource-dialog');
                if (d) d.hide();
            });
            document.body.addEventListener('htmx:afterSwap', function(evt) {
                if (evt.detail.xhr && evt.detail.xhr.getResponseHeader) {
                    try {
                        var h = evt.detail.xhr.getResponseHeader('HX-Trigger');
                        if (h) {
                            var t = JSON.parse(h);
                            if (t.closeDialog) document.body.dispatchEvent(new CustomEvent('closeDialog'));
                        }
                    } catch (_) {}
                }
            });
        })();
    </script>
    {% endif %}
</body>
</html>
